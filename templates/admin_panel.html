<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GhostMiner Admin Panel</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
    <style>
        body {
            background: #18181c;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
        }
        .panel {
            background: #222225;
            margin: 48px auto;
            max-width: 600px;
            padding: 36px 48px 24px 48px;
            border-radius: 16px;
            box-shadow: 0 8px 44px #0008;
        }
        h1 { color: #fff; margin-bottom: 8px; }
        h2 { margin-top: 32px; margin-bottom: 8px; color: #fff; font-size: 1.2em;}
        .logout { color: #8ab6ff; text-decoration: underline; font-size: 1em; float: right; margin-top: 8px;}
        table { width: 100%; margin-top: 12px; border-collapse: collapse;}
        th, td { text-align: left; padding: 4px 8px; }
        th { color: #ff5277; }
        tr { border-bottom: 1px solid #333; }
        .btn { background: #ff3b3b; border: none; color: #fff; padding: 6px 18px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn:disabled { opacity: 0.4; }
        .btn-green { background: #2ecc40; }
        .btn-gray { background: #666; }
        input, select {
            background: #232323;
            color: #fff;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 7px 10px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 1em;
        }
        .checkbox { transform: scale(1.3); }
        .section { margin-bottom: 28px; }
        .license-row[expired="true"] td { color: #888; }
    </style>
</head>
<body>
<div class="panel">
    <a href="/admin/logout" class="logout">Logout</a>
    <h1>GhostMiner Admin Panel</h1>

    <div class="section">
        <h2>Registered Users</h2>
        <table id="users-table">
            <thead>
            <tr><th>ID</th><th>Username</th><th>Email</th><th>License Key</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <h2>Add New User</h2>
        <form id="add-user-form" autocomplete="off">
            <input id="new-username" placeholder="Username" required>
            <input id="new-email" placeholder="Email" required>
            <input id="new-password" type="password" placeholder="Password" required>
            <input id="new-license" placeholder="License Key" required>
            <button class="btn btn-green" type="submit">Create User</button>
        </form>
        <span id="add-user-status"></span>
    </div>

    <div class="section">
        <h2>Send Message</h2>
        <form id="msg-form" autocomplete="off">
            <input id="msg-target" placeholder="Targets (comma usernames or 'all')" style="width:180px;">
            <input id="msg-body" placeholder="Message" style="width:230px;">
            <button class="btn" type="submit">Send</button>
        </form>
        <span id="msg-status"></span>
    </div>

    <div class="section">
        <h2>License Generator</h2>
        <form id="keygen-form" autocomplete="off">
            <select id="license-duration">
                <option value="24h">24 Hours</option>
                <option value="1w">1 Week</option>
                <option value="1m">1 Month</option>
                <option value="lifetime" selected>Lifetime</option>
            </select>
            <button class="btn" type="submit">Generate 16-Digit Key</button>
            <input id="keygen-result" readonly style="width:170px;">
        </form>
    </div>

    <div class="section">
        <h2>Manage Licenses</h2>
        <table id="licenses-table">
            <thead>
            <tr><th>Key</th><th>Active</th><th>Duration</th><th>Time Left</th><th>Delete</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
function formatTimeLeft(secs) {
    if (secs === "Lifetime") return "Lifetime";
    if (secs <= 0) return "Expired";
    let d = Math.floor(secs/86400), h=Math.floor(secs/3600)%24, m=Math.floor(secs/60)%60, s=secs%60;
    let arr = [];
    if (d) arr.push(`${d}d`); if (h) arr.push(`${h}h`);
    if (m) arr.push(`${m}m`); if (s && arr.length < 2) arr.push(`${s}s`);
    return arr.join(" ");
}
function escape(s) { return (""+s).replace(/[<>&"]/g, c=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[c])); }

function loadUsers() {
    fetch('/api/users').then(r=>r.json()).then(users=>{
        let tb = document.querySelector("#users-table tbody");
        tb.innerHTML = "";
        users.forEach(u=>{
            tb.innerHTML += `<tr>
                <td>${u.id}</td>
                <td>${escape(u.username)}</td>
                <td>${escape(u.email||"")}</td>
                <td>${escape(u.license_key||"")}</td>
            </tr>`;
        });
    });
}

function loadLicenses() {
    fetch('/api/licenses').then(r=>r.json()).then(keys=>{
        let tb = document.querySelector("#licenses-table tbody");
        tb.innerHTML = "";
        keys.forEach(k=>{
            let expired = k.time_left !== "Lifetime" && k.time_left <= 0;
            tb.innerHTML += `<tr class="license-row" expired="${expired}">
                <td>${escape(k.key)}</td>
                <td>
                  <input type="checkbox" class="checkbox" ${k.active&&!expired?"checked":""} onchange="toggleActive('${k.key}',this.checked)">
                </td>
                <td>
                  <select onchange="changeDuration('${k.key}',this.value)">
                      <option value="24h" ${k.duration=="24h"?"selected":""}>24h</option>
                      <option value="1w" ${k.duration=="1w"?"selected":""}>1w</option>
                      <option value="1m" ${k.duration=="1m"?"selected":""}>1m</option>
                      <option value="lifetime" ${k.duration=="lifetime"?"selected":""}>Lifetime</option>
                  </select>
                </td>
                <td>${formatTimeLeft(k.time_left)}</td>
                <td><button class="btn btn-gray" onclick="delLicense('${k.key}')">X</button></td>
            </tr>`;
        });
    });
}
function delLicense(key) {
    if (!confirm("Delete this license key?")) return;
    fetch("/api/licenses/delete/"+key, {method:"POST"}).then(loadLicenses);
}
function toggleActive(key,on) {
    fetch(`/api/licenses/${on?"activate":"deactivate"}/${key}`, {method:"POST"}).then(loadLicenses);
}
function changeDuration(key,duration) {
    fetch(`/api/licenses/update_time/${key}`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({duration})
    }).then(loadLicenses);
}
document.getElementById("keygen-form").onsubmit = function(e){
    e.preventDefault();
    let duration = document.getElementById("license-duration").value;
    fetch("/api/licenses",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({duration})
    }).then(r=>r.json()).then(resp=>{
        document.getElementById("keygen-result").value = resp.key;
        loadLicenses();
    });
};

document.getElementById("add-user-form").onsubmit = function(e){
    e.preventDefault();
    let u = document.getElementById("new-username").value,
        e1 = document.getElementById("new-email").value,
        p = document.getElementById("new-password").value,
        k = document.getElementById("new-license").value;
    fetch("/api/users",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username:u, email:e1, password:p, license_key:k})
    }).then(r=>r.json()).then(resp=>{
        document.getElementById("add-user-status").innerText = resp.ok ? "User created!" : (resp.error||"Failed");
        loadUsers();
        setTimeout(()=>document.getElementById("add-user-status").innerText="",1600);
    });
};

document.getElementById("msg-form").onsubmit = function(e){
    e.preventDefault();
    let t=document.getElementById("msg-target").value.trim()||"all",
        m=document.getElementById("msg-body").value.trim();
    if(!m) return;
    fetch("/api/messages",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({target:t, message:m})
    }).then(r=>r.json()).then(resp=>{
        document.getElementById("msg-status").innerText = resp.ok ? "Message sent!" : (resp.error||"Failed");
        setTimeout(()=>document.getElementById("msg-status").innerText="",1300);
    });
};

window.toggleActive = toggleActive;
window.changeDuration = changeDuration;
window.delLicense = delLicense;

loadLicenses();
loadUsers();
</script>
</body>
</html>
